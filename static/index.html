<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>chatterbox</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #1a1a2e; color: #eee; display: flex; height: 100vh; }
  #login { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; gap: 12px; }
  #login h1 { font-size: 2rem; color: #e94560; }
  #login input, #login button { padding: 10px 16px; border-radius: 6px; border: none; font-size: 1rem; }
  #login input { background: #16213e; color: #eee; width: 240px; }
  #login button { background: #e94560; color: #fff; cursor: pointer; }
  #app { display: none; width: 100%; height: 100%; }
  .sidebar { width: 220px; background: #16213e; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  .sidebar h2 { font-size: 0.9rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
  .sidebar ul { list-style: none; }
  .sidebar li { padding: 6px 8px; cursor: pointer; border-radius: 4px; font-size: 0.95rem; }
  .sidebar li:hover, .sidebar li.active { background: #0f3460; }
  .sidebar input { padding: 6px 8px; border-radius: 4px; border: none; background: #1a1a2e; color: #eee; font-size: 0.85rem; }
  .main { flex: 1; display: flex; flex-direction: column; }
  .header { padding: 12px 16px; background: #16213e; border-bottom: 1px solid #0f3460; font-weight: 600; }
  .messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
  .msg { max-width: 70%; padding: 8px 12px; border-radius: 8px; font-size: 0.95rem; }
  .msg.chat { background: #0f3460; }
  .msg.system { background: transparent; color: #888; font-size: 0.85rem; text-align: center; align-self: center; }
  .msg .user { color: #e94560; font-weight: 600; font-size: 0.85rem; }
  .msg .time { color: #666; font-size: 0.75rem; margin-left: 8px; }
  .input-bar { display: flex; padding: 12px 16px; background: #16213e; gap: 8px; }
  .input-bar input { flex: 1; padding: 10px; border-radius: 6px; border: none; background: #1a1a2e; color: #eee; font-size: 1rem; }
  .input-bar button { padding: 10px 20px; border-radius: 6px; border: none; background: #e94560; color: #fff; cursor: pointer; font-size: 1rem; }
  .users-panel { width: 180px; background: #16213e; padding: 16px; border-left: 1px solid #0f3460; }
  .users-panel h3 { font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: 8px; }
  .users-panel li { padding: 4px 0; font-size: 0.9rem; }
</style>
</head>
<body>

<div id="login">
  <h1>ðŸ’¬ chatterbox</h1>
  <input id="usernameInput" placeholder="Enter your name" autofocus>
  <button onclick="connect()">Join Chat</button>
</div>

<div id="app">
  <div class="sidebar">
    <h2>Rooms</h2>
    <ul id="roomList"></ul>
    <input id="newRoom" placeholder="New room..." onkeydown="if(event.key==='Enter')joinRoom(this.value)">
  </div>
  <div class="main">
    <div class="header" id="roomHeader">Select a room</div>
    <div class="messages" id="messages"></div>
    <div class="input-bar">
      <input id="msgInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMessage()">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
  <div class="users-panel">
    <h3>Online</h3>
    <ul id="userList"></ul>
  </div>
</div>

<script>
let ws, username, currentRoom = '';

function connect() {
  username = document.getElementById('usernameInput').value.trim();
  if (!username) return;

  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws?user=${encodeURIComponent(username)}`);

  ws.onopen = () => {
    document.getElementById('login').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    joinRoom('general');
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    handleMessage(msg);
  };

  ws.onclose = () => {
    addSystemMsg('Disconnected from server');
  };
}

function handleMessage(msg) {
  switch (msg.type) {
    case 'chat':
      if (msg.room === currentRoom) addChatMsg(msg);
      break;
    case 'join':
      if (msg.room === currentRoom) addSystemMsg(`${msg.user} joined`);
      break;
    case 'leave':
      if (msg.room === currentRoom) addSystemMsg(`${msg.user} left`);
      break;
    case 'history':
      if (msg.room === currentRoom) {
        document.getElementById('messages').innerHTML = '';
        (msg.messages || []).forEach(m => addChatMsg(m));
      }
      break;
    case 'presence':
      if (msg.room === currentRoom) updateUsers(msg.users || []);
      break;
    case 'error':
      addSystemMsg(`Error: ${msg.message}`);
      break;
  }
}

function joinRoom(name) {
  name = name.trim();
  if (!name) return;
  if (currentRoom) ws.send(JSON.stringify({ type: 'leave', room: currentRoom }));
  currentRoom = name;
  document.getElementById('roomHeader').textContent = `#${name}`;
  document.getElementById('messages').innerHTML = '';
  document.getElementById('newRoom').value = '';
  ws.send(JSON.stringify({ type: 'join', room: name }));
  updateRoomList();
}

function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || !currentRoom) return;
  ws.send(JSON.stringify({ type: 'chat', room: currentRoom, text }));
  input.value = '';
}

function addChatMsg(msg) {
  const div = document.createElement('div');
  div.className = 'msg chat';
  const ts = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : '';
  div.innerHTML = `<span class="user">${esc(msg.user)}</span><span class="time">${ts}</span><br>${esc(msg.text)}`;
  const container = document.getElementById('messages');
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function addSystemMsg(text) {
  const div = document.createElement('div');
  div.className = 'msg system';
  div.textContent = text;
  const container = document.getElementById('messages');
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function updateUsers(users) {
  const ul = document.getElementById('userList');
  ul.innerHTML = users.map(u => `<li>${esc(u)}</li>`).join('');
}

function updateRoomList() {
  fetch('/api/rooms').then(r => r.json()).then(rooms => {
    const ul = document.getElementById('roomList');
    ul.innerHTML = (rooms || []).map(r =>
      `<li class="${r.name === currentRoom ? 'active' : ''}" onclick="joinRoom('${esc(r.name)}')">#${esc(r.name)} (${r.user_count})</li>`
    ).join('');
  }).catch(() => {});
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

setInterval(updateRoomList, 5000);
</script>
</body>
</html>
